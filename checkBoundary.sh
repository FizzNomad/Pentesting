#!/bin/bash

# Files to store the questions, help texts, and log
QUESTIONS_FILE="questions.txt"
HELP_TEXTS_FILE="help_texts.txt"
LOG_FILE="checklist.log"

# Directory to store the log file
LOG_DIR="logs"

# Read the questions and help texts from their respective files into arrays
mapfile -t QUESTIONS < $QUESTIONS_FILE
mapfile -t HELP_TEXTS < $HELP_TEXTS_FILE

function display_help {
  local question_index=$1
  echo "${HELP_TEXTS[$question_index]}"
}

function ask_question {
  local question_index=$1
  local question="${QUESTIONS[$question_index]}"
  local answer
  local timestamp=$(date +"%Y-%m-%dT%H:%M:%S")

  # Check if the log file exists
  if [ ! -f "$LOG_DIR/$LOG_FILE" ]; then
    echo "Creating new log"
    mkdir -p $LOG_DIR
    touch "$LOG_DIR/$LOG_FILE"
  fi

  # Check if the question has already been answered
  if grep -q "^# $question$" "$LOG_DIR/$LOG_FILE"; then
    # Display the question and the existing answer
    echo "This question has already been answered:"
    grep "^# $question$" "$LOG_DIR/$LOG_FILE" -A 2

    # Offer to append or modify the answer
    read -p "Do you want to [a]ppend, [m]odify, or [s]kip? " choice
    case $choice in
      a)
        echo "Appending to $question..."
        answer_line=$(grep -n "^# $question$" "$LOG_DIR/$LOG_FILE" | cut -f1 -d:)
        existing_answer=$(sed -n "${answer_line}p" "$LOG_DIR/$LOG_FILE")
        read -p "What comment would you like to add to your answer? " comment
        cp "$LOG_DIR/$LOG_FILE" "$LOG_DIR/$LOG_FILE.bak"
        sed -i "${answer_line}s/$existing_answer/$existing_answer\n$timestamp\n$comment/" "$LOG_DIR/$LOG_FILE"
        ;;
      m)
        read -p "$question (yes/no/skip/help) " answer
        if [[ "$answer" != "help" ]]; then
          cp "$LOG_DIR/$LOG_FILE" "$LOG_DIR/$LOG_FILE.bak"
          sed -i "/^# $question$/{n;s/.*/$timestamp/;}" "$LOG_DIR/$LOG_FILE"
          sed -i "/^# $question$/{n;n;s/.*/$answer/;}" "$LOG_DIR/$LOG_FILE"
        fi
        ;;
      s)
        echo "Skipping $question..."
        ;;
    esac
  else
    # Ask the question and record the answer
    echo "# $question" >> "$LOG_DIR/$LOG_FILE"
    read -p "$question (yes/no/skip/help) " answer

    if [[ $answer == "help" ]]; then
      display_help "$question_index"
      ask_question "$question_index"
      return
    fi

    echo "$timestamp" >> "$LOG_DIR/$LOG_FILE"
    echo "$answer" >> "$LOG_DIR/$LOG_FILE"
  fi
}

if [ ! -f $QUESTIONS_FILE ] || [ ! -f $HELP_TEXTS_FILE ]; then
  echo "Error: questions.txt and help_texts.txt files must exist in the same directory as the script."
  exit 1
fi

for i in "${!QUESTIONS[@]}"; do
  ask_question $i
done

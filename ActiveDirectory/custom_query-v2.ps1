# Import the Active Directory module
Import-Module ActiveDirectory

function Get-DateRange {
    [CmdletBinding()]
    param()

    $startDateInput = Read-Host "Enter the start date (yyyy-MM-dd)"
    $endDateInput = Read-Host "Enter the end date (yyyy-MM-dd)"

    try {
        $startDate = [datetime]::ParseExact($startDateInput, "yyyy-MM-dd", $null)
        $endDate = [datetime]::ParseExact($endDateInput, "yyyy-MM-dd", $null)
        return $startDate, $endDate
    }
    catch {
        Write-Host "Invalid date format. Please try again." -ForegroundColor Red
        return Get-DateRange
    }
}

# Prompt the user to enter the date range
$startDate, $endDate = Get-DateRange

# Specify the distinguished name of the Disabled Users OU
$disabledUsersOU = "OU=Disabled Users,DC=yourdomain,DC=com"

# Specify the output file path
$outputFilePath = "FilteredUsers.csv"

try {
    # Get all AD user accounts created within the specified date range
    $users = Get-ADUser -Filter {Created -ge $startDate -and Created -le $endDate} -Properties Created, DistinguishedName, whenChanged, userAccountControl

    # Filter out the users that are members of the Disabled Users OU
    $filteredUsers = $users | Where-Object { $_.DistinguishedName -notlike "*,$disabledUsersOU" }

    # Add a custom property to store the disabled date
    $filteredUsersWithDisabledDate = $filteredUsers | ForEach-Object {
        $disabledDate = if ($_.userAccountControl -band 2) { $_.whenChanged }
        $_ | Add-Member -NotePropertyName DisabledDate -NotePropertyValue $disabledDate -PassThru
    }

    # Export the results to a CSV file
    $filteredUsersWithDisabledDate | Select-Object Name, SamAccountName, Created, DistinguishedName, DisabledDate | Export-Csv -Path $outputFilePath -NoTypeInformation

    # Display a message indicating the number of users exported
    Write-Host "Successfully exported $($filteredUsersWithDisabledDate.Count) users to $outputFilePath" -ForegroundColor Green
}
catch {
    # Display an error message if something goes wrong
    Write-Host "An error occurred: $_" -ForegroundColor Red
}

# Import Active Directory module if not already loaded
if (-not (Get-Module -Name ActiveDirectory)) {
    Import-Module ActiveDirectory
}

# Get the current date
$CurrentDate = Get-Date

# Function to check if a user has never changed their password
function Check-NeverChangedPassword($user) {
    return (($CurrentDate - $user.PasswordLastSet).TotalDays -eq $user.AccountLockoutTime.TotalDays)
}

# Function to check if a user has never logged in
function Check-NeverLoggedIn($user) {
    return ($user.LastLogonDate -eq $null)
}

# Query Active Directory for all active users
$ActiveUsers = Get-ADUser -Filter {(Enabled -eq $true)} -Properties PasswordLastSet, AccountLockoutTime, LastLogonDate, PasswordNeverExpires, PasswordNotRequired

# Filter users based on various conditions
$NeverChangedPasswordOrNeverLoggedIn = $ActiveUsers | Where-Object { (Check-NeverChangedPassword $_) -or (Check-NeverLoggedIn $_) }
$NonExpiringPasswords = $ActiveUsers | Where-Object { $_.PasswordNeverExpires -eq $true }
$NoPasswordRequired = $ActiveUsers | Where-Object { $_.PasswordNotRequired -eq $true }

# Stale user accounts (inactive for more than 90 days)
$InactiveDaysThreshold = 90
$StaleAccounts = $ActiveUsers | Where-Object { $_.LastLogonDate -lt $CurrentDate.AddDays(-$InactiveDaysThreshold) }

# Export results to CSV files
$NeverChangedPasswordOrNeverLoggedIn | Select-Object Name, PasswordLastSet, LastLogonDate | Export-Csv -Path "NeverChangedPasswordOrNeverLoggedIn.csv" -NoTypeInformation
$NonExpiringPasswords | Select-Object Name, PasswordNeverExpires | Export-Csv -Path "NonExpiringPasswords.csv" -NoTypeInformation
$NoPasswordRequired | Select-Object Name, PasswordNotRequired | Export-Csv -Path "NoPasswordRequired.csv" -NoTypeInformation
$StaleAccounts | Select-Object Name, LastLogonDate | Export-Csv -Path "StaleAccounts.csv" -NoTypeInformation

# Display summary of insecure settings
Write-Host "Number of users who have never changed their password or never logged in: $($NeverChangedPasswordOrNeverLoggedIn.Count)"
Write-Host "Number of users with non-expiring passwords: $($NonExpiringPasswords.Count)"
Write-Host "Number of users with passwords not required: $($NoPasswordRequired.Count)"
Write-Host "Number of stale user accounts: $($StaleAccounts.Count)"
